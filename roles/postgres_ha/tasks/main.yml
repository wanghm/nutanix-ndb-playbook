---
# roles/postgres_ha/tasks/main.yml

# OS common settings
- name: Create OS group postgres
  group:
    name: postgres
    state: present

- name: Create OS user postgres
  user:
    name: postgres
    home: /home/postgres
    group: postgres
    state: present

- name: Create OS group era
  group:
    name: era
    state: present

- name: Create OS user era
  user:
    name: era
    password: "{{ era_user_password }}"
    group: era
    home: /home/era
    state: present

- name: Enable passwordless sudo for era
  copy:
    content: "era ALL=(ALL:ALL) NOPASSWD:ALL"
    dest: /etc/sudoers.d/era_nopasswd
    mode: 0440

# centos7 specific tasks
- include: centos_7.yml
  when:
   - ansible_distribution == "CentOS"
   - ansible_distribution_major_version == "7"

# Install postgresql from source
- name: download postgresql packages
  get_url:
    url: "{{ postgressql_src_url }}"
    dest: "{{ src_dir }}"

- name: extract postgresql src
  command: chdir={{ src_dir }} tar xzvf "{{ postgressql_src_ver }}.tar.gz"

- name: configure postgresql
  command: chdir={{src_dir}}/{{postgressql_src_ver}} ./configure --prefix={{ postgres_dir }}

- name: make postgresql
  command: chdir={{src_dir}}/{{postgressql_src_ver}} make

- name: make all postgresql
  command: chdir={{src_dir}}/{{postgressql_src_ver}} make all

- name: make world postgresql
  command: chdir={{src_dir}}/{{postgressql_src_ver}} make world

- name: make install postgresql
  command: chdir={{src_dir}}/{{postgressql_src_ver}} make install

- name: make install-world postgresql
  command: chdir={{src_dir}}/{{postgressql_src_ver}} make install-world

- name: Disabling seLinux state
  command: 'sed -i -e "s/^SELINUX=.*/SELINUX=disabled/g" /etc/sysconfig/selinux'

- name: Print the changes in seLinux Configurtion file 
  command: grep SELINUX /etc/sysconfig/selinux
  register: sevalue
- debug: msg="{{ sevalue.stdout_lines }}"

